{% extends 'base.html' %}
{% load static %}

{% block title %}Patient Notifications{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1>
                    <i class="fas fa-bell"></i> Notifications
                </h1>
                {% if unread_count > 0 %}
                    <span class="badge bg-danger badge-lg">{{ unread_count }} Unread</span>
                {% endif %}
            </div>
            <p class="text-muted">Keep up with important updates about your hospital stay or loved ones.</p>
        </div>
    </div>

    <div class="row">
        <div class="col-md-3">
            <div class="card mb-4">
                <div class="card-body text-center">
                    <h5>Total Notifications</h5>
                    <h2 class="text-primary">{{ total_count }}</h2>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-body text-center">
                    <h5>Unread</h5>
                    <h2 class="text-warning">{{ unread_count }}</h2>
                </div>
            </div>

            <div class="card">
                <div class="card-body">
                    <h6 class="mb-3">Filter by Type</h6>
                    <div class="list-group list-group-flush">
                        <a href="?type=all" class="list-group-item list-group-item-action {% if not request.GET.type or request.GET.type == 'all' %}active{% endif %}">
                            All <span class="badge bg-secondary float-end">{{ total_count }}</span>
                        </a>
                        <a href="?type=admission" class="list-group-item list-group-item-action {% if request.GET.type == 'admission' %}active{% endif %}">
                            Admissions <span class="badge bg-secondary float-end">{{ admission_count }}</span>
                        </a>
                        <a href="?type=discharge" class="list-group-item list-group-item-action {% if request.GET.type == 'discharge' %}active{% endif %}">
                            Discharges <span class="badge bg-secondary float-end">{{ discharge_count }}</span>
                        </a>
                        <a href="?type=transfer" class="list-group-item list-group-item-action {% if request.GET.type == 'transfer' %}active{% endif %}">
                            Transfers <span class="badge bg-secondary float-end">{{ transfer_count }}</span>
                        </a>
                        <a href="?type=appointment" class="list-group-item list-group-item-action {% if request.GET.type == 'appointment' %}active{% endif %}">
                            Appointments <span class="badge bg-secondary float-end">{{ appointment_count }}</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-9">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Notification List</h5>
                    {% if unread_count > 0 %}
                        <button class="btn btn-sm btn-outline-primary" id="mark-all-read">
                            <i class="fas fa-check-double"></i> Mark All as Read
                        </button>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if notifications %}
                        <div class="notification-list">
                            {% for notification in notifications %}
                            <div class="notification-item {% if not notification.is_read %}unread-notification border-start border-warning border-4{% else %}border-start border-success border-4{% endif %} p-3 mb-3 rounded bg-light">
                                <div class="row align-items-center">
                                    <div class="col-md-10">
                                        <div class="d-flex align-items-start">
                                            <div class="notification-icon me-3">
                                                {% if notification.notification_type == 'admission' %}
                                                    <i class="fas fa-check-circle text-success fa-2x"></i>
                                                {% elif notification.notification_type == 'discharge' %}
                                                    <i class="fas fa-sign-out-alt text-info fa-2x"></i>
                                                {% elif notification.notification_type == 'transfer' %}
                                                    <i class="fas fa-exchange-alt text-warning fa-2x"></i>
                                                {% elif notification.notification_type == 'appointment' %}
                                                    <i class="fas fa-calendar-alt text-primary fa-2x"></i>
                                                {% else %}
                                                    <i class="fas fa-envelope text-secondary fa-2x"></i>
                                                {% endif %}
                                            </div>
                                            <div class="flex-grow-1">
                                                <div class="d-flex justify-content-between align-items-start mb-2">
                                                    <h6 class="mb-0">
                                                        {{ notification.title }}
                                                        {% if not notification.is_read %}
                                                            <span class="badge bg-warning">NEW</span>
                                                        {% endif %}
                                                    </h6>
                                                    <small class="text-muted">
                                                        {% now "U" as current_timestamp %}
                                                        {{ notification.created_at|timesince }} ago
                                                    </small>
                                                </div>
                                                <p class="text-muted mb-2">{{ notification.message }}</p>
                                                <div class="small">
                                                    <span class="badge bg-light text-dark">
                                                        {{ notification.get_notification_type_display }}
                                                    </span>
                                                    {% if notification.send_email %}
                                                        <span class="badge bg-info">
                                                            <i class="fas fa-envelope"></i> Email Sent
                                                        </span>
                                                    {% endif %}
                                                    {% if notification.send_sms %}
                                                        <span class="badge bg-info">
                                                            <i class="fas fa-sms"></i> SMS Sent
                                                        </span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-2 text-end">
                                        {% if not notification.is_read %}
                                            <button class="btn btn-sm btn-outline-primary mark-as-read" data-notification-id="{{ notification.id }}">
                                                <i class="fas fa-check"></i> Mark Read
                                            </button>
                                        {% else %}
                                            <span class="text-success">
                                                <i class="fas fa-check-circle"></i> Read
                                            </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        {% if page_obj.has_other_pages %}
                        <nav class="mt-4">
                            <ul class="pagination justify-content-center">
                                {% if page_obj.has_previous %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page=1">First</a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a>
                                    </li>
                                {% endif %}

                                <li class="page-item active">
                                    <span class="page-link">Page {{ page_obj.number }}</span>
                                </li>

                                {% if page_obj.has_next %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">Last</a>
                                    </li>
                                {% endif %}
                            </ul>
                        </nav>
                        {% endif %}
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-inbox"></i> No notifications yet.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .notification-item {
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .notification-item:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .unread-notification {
        background-color: #fff3cd !important;
    }

    .notification-icon {
        flex-shrink: 0;
    }

    .badge-lg {
        font-size: 0.95rem;
        padding: 0.5rem 1rem;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Mark as read functionality
    const markAsReadButtons = document.querySelectorAll('.mark-as-read');
    markAsReadButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const notificationId = this.dataset.notificationId;
            markNotificationAsRead(notificationId, this);
        });
    });

    // Mark all as read functionality
    const markAllReadBtn = document.getElementById('mark-all-read');
    if (markAllReadBtn) {
        markAllReadBtn.addEventListener('click', function(e) {
            e.preventDefault();
            markAllNotificationsAsRead();
        });
    }

    function markNotificationAsRead(notificationId, buttonElement) {
        fetch(`/hospital/patient-notifications/${notificationId}/mark-read/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update button to show read status
                const notificationItem = buttonElement.closest('.notification-item');
                notificationItem.classList.remove('unread-notification', 'border-warning');
                notificationItem.classList.add('border-success');
                buttonElement.innerHTML = '<span class="text-success"><i class="fas fa-check-circle"></i> Read</span>';
                buttonElement.disabled = true;
                
                // Update unread count
                updateUnreadCount();
            }
        })
        .catch(error => console.error('Error:', error));
    }

    function markAllNotificationsAsRead() {
        const unreadButtons = document.querySelectorAll('.mark-as-read');
        let processed = 0;
        
        unreadButtons.forEach(button => {
            const notificationId = button.dataset.notificationId;
            fetch(`/hospital/patient-notifications/${notificationId}/mark-read/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const notificationItem = button.closest('.notification-item');
                    notificationItem.classList.remove('unread-notification', 'border-warning');
                    notificationItem.classList.add('border-success');
                    button.innerHTML = '<span class="text-success"><i class="fas fa-check-circle"></i> Read</span>';
                    button.disabled = true;
                }
                processed++;
                if (processed === unreadButtons.length) {
                    updateUnreadCount();
                }
            })
            .catch(error => console.error('Error:', error));
        });
    }

    function updateUnreadCount() {
        fetch('/hospital/api/notifications/unread-count/')
        .then(response => response.json())
        .then(data => {
            location.reload();
        })
        .catch(error => console.error('Error:', error));
    }
});
</script>
{% endblock %}
