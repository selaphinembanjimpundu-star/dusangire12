{% extends 'hospital_wards/base.html' %}
{% load static %}

{% block title %}Occupancy Report{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-md-12">
            <h2 class="mb-4"><i class="fas fa-chart-bar"></i> Hospital Occupancy Report</h2>
        </div>
    </div>

    <!-- Overall Statistics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-primary">
                <div class="card-body text-center">
                    <h5 class="card-title text-muted">Total Beds</h5>
                    <h2 class="text-primary">{{ total_beds }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-success">
                <div class="card-body text-center">
                    <h5 class="card-title text-muted">Occupied Beds</h5>
                    <h2 class="text-success">{{ occupied_beds }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-warning">
                <div class="card-body text-center">
                    <h5 class="card-title text-muted">Available Beds</h5>
                    <h2 class="text-warning">{{ total_beds|add:"-occupied_beds" }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-info">
                <div class="card-body text-center">
                    <h5 class="card-title text-muted">Occupancy Rate</h5>
                    <h2 class="text-info">{{ occupancy_rate }}%</h2>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-info" role="progressbar" 
                             style="width: {{ occupancy_rate }}%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ward-by-Ward Breakdown -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-hospital"></i> Ward Occupancy Breakdown</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Ward Name</th>
                                    <th>Total Beds</th>
                                    <th>Occupied</th>
                                    <th>Available</th>
                                    <th>Maintenance</th>
                                    <th>Occupancy Rate</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for ward in wards %}
                                <tr>
                                    <td><strong>{{ ward.name }}</strong></td>
                                    <td>{{ ward.total_beds }}</td>
                                    <td>
                                        <span class="badge bg-success">{{ ward.occupied_beds }}</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-warning">{{ ward.available_beds }}</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">{{ ward.maintenance_beds }}</span>
                                    </td>
                                    <td>
                                        {% widthratio ward.occupied_beds ward.total_beds 100 as occ_rate %}
                                        <div class="progress" style="width: 100px;">
                                            <div class="progress-bar" role="progressbar" 
                                                 style="width: {{ occ_rate }}%">{{ occ_rate }}%</div>
                                        </div>
                                    </td>
                                    <td>
                                        {% if occ_rate >= 90 %}
                                            <span class="badge bg-danger">High</span>
                                        {% elif occ_rate >= 70 %}
                                            <span class="badge bg-warning">Moderate</span>
                                        {% else %}
                                            <span class="badge bg-success">Low</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Admissions -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-sign-in-alt"></i> Recent Admissions (Last 10)</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th>Patient</th>
                                    <th>Bed</th>
                                    <th>Reason</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for admission in recent_admissions %}
                                <tr>
                                    <td>
                                        <strong>{{ admission.patient.get_full_name }}</strong>
                                    </td>
                                    <td>{{ admission.bed.bed_number }}</td>
                                    <td>
                                        <span class="badge bg-info">{{ admission.reason }}</span>
                                    </td>
                                    <td>{{ admission.admission_date|date:"M d, Y" }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center text-muted">No recent admissions</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Discharges -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-sign-out-alt"></i> Recent Discharges (Last 10)</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th>Patient</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for discharge in recent_discharges %}
                                <tr>
                                    <td>
                                        <strong>{{ discharge.admission.patient.get_full_name }}</strong>
                                    </td>
                                    <td>
                                        <span class="badge 
                                            {% if discharge.discharge_status == 'discharged' %}bg-success
                                            {% elif discharge.discharge_status == 'referred' %}bg-warning
                                            {% else %}bg-secondary{% endif %}">
                                            {{ discharge.discharge_status }}
                                        </span>
                                    </td>
                                    <td>{{ discharge.discharge_date|date:"M d, Y" }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="3" class="text-center text-muted">No recent discharges</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Options -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="d-flex gap-2">
                <a href="{% url 'hospital_wards:hospital_manager_dashboard' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
                <button class="btn btn-outline-primary" onclick="window.print()">
                    <i class="fas fa-print"></i> Print Report
                </button>
                <button class="btn btn-outline-success" onclick="exportToCSV()">
                    <i class="fas fa-file-csv"></i> Export to CSV
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function exportToCSV() {
    const table = document.querySelector('table');
    let csv = [];
    let rows = table.querySelectorAll('tr');
    
    rows.forEach(row => {
        let rowData = [];
        row.querySelectorAll('td, th').forEach(cell => {
            rowData.push('"' + cell.innerText.replace(/"/g, '""') + '"');
        });
        csv.push(rowData.join(','));
    });
    
    const csvContent = 'data:text/csv;charset=utf-8,' + encodeURI(csv.join('\n'));
    const link = document.createElement('a');
    link.setAttribute('href', csvContent);
    link.setAttribute('download', 'occupancy_report.csv');
    link.click();
}
</script>
{% endblock %}
