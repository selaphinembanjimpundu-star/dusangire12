<!-- templates/reviews/item_reviews.html -->
{% extends 'base.html' %}
{% load static %}
{% load review_filters %}

{% block title %}Reviews for {{ menu_item.name }} - Dusangire{% endblock %}

{% block extra_css %}
<style>
  /* Main container to prevent footer overlap */
  .main-content-wrapper {
    min-height: calc(100vh - 300px);
    /* Adjust based on your header/footer height */
    padding-bottom: 3rem;
  }

  /* Review Cards */
  .review-card {
    border: 1px solid #e9ecef;
    border-radius: 0.75rem;
    margin-bottom: 1.5rem;
    transition: all 0.2s ease;
  }

  .review-card:hover {
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
  }

  .review-header {
    margin-bottom: 1rem;
  }

  .review-meta {
    font-size: 0.85rem;
    color: #6c757d;
  }

  .review-title {
    font-weight: 600;
    margin-bottom: 0.5rem;
  }

  .review-content {
    line-height: 1.6;
    color: #495057;
    margin-bottom: 1rem;
  }

  .review-actions {
    display: flex;
    gap: 0.5rem;
    align-items: center;
    padding-top: 1rem;
    border-top: 1px solid #e9ecef;
  }

  /* Rating Styles */
  .rating-stars {
    color: #ffc107;
  }

  .verified-badge {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
  }

  .helpful-btn {
    font-size: 0.9rem;
    padding: 0.25rem 0.75rem;
    border-radius: 0.5rem;
    transition: all 0.2s ease;
  }

  .helpful-btn:hover {
    transform: scale(1.05);
  }

  .helpful-btn.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-color: #667eea;
  }

  /* Empty State */
  .empty-state {
    text-align: center;
    padding: 4rem 1rem;
    background: #f8f9fa;
    border-radius: 0.75rem;
    margin: 2rem 0;
  }

  .empty-state-icon {
    font-size: 3rem;
    color: #dee2e6;
    margin-bottom: 1rem;
  }

  /* Sidebar Cards */
  .sidebar-card {
    border: 1px solid #e9ecef;
    border-radius: 0.75rem;
    margin-bottom: 1.5rem;
  }

  .category-badge {
    background-color: #e8f5e9;
    color: #2e7d32;
    padding: 0.25rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.85rem;
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .main-content-wrapper {
      min-height: calc(100vh - 250px);
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="main-content-wrapper">
  <!-- Breadcrumb -->
  <nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{% url 'home' %}" class="text-decoration-none">Home</a></li>
      <li class="breadcrumb-item"><a href="{% url 'menu:menu_list' %}" class="text-decoration-none">Menu</a></li>
      <li class="breadcrumb-item">
        <a href="{% url 'menu:menu_detail' menu_item.id %}" class="text-decoration-none">{{ menu_item.name }}</a>
      </li>
      <li class="breadcrumb-item active" aria-current="page">Reviews</li>
    </ol>
  </nav>

  <!-- Page Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4">
        <div class="mb-3 mb-md-0">
          <h1 class="h2 fw-bold mb-2">Reviews for {{ menu_item.name }}</h1>
          <div class="d-flex align-items-center flex-wrap">
            <div class="rating-stars me-2">
              {% if menu_item.average_rating %}
              {% for i in "12345"|make_list %}
              {% if forloop.counter <= menu_item.average_rating|default:0|floatformat:0 %} <i class="bi bi-star-fill">
                </i>
                {% else %}
                <i class="bi bi-star"></i>
                {% endif %}
                {% endfor %}
                <span class="ms-2">{{ menu_item.average_rating|floatformat:1 }} out of 5</span>
                {% else %}
                <span class="text-muted">No ratings yet</span>
                {% endif %}
            </div>
            <span class="ms-3 text-muted">{{ reviews.count }} review{{ reviews.count|pluralize }}</span>
          </div>
        </div>
        <div>
          <a href="{% url 'reviews:add_review' menu_item.id %}" class="btn btn-primary btn-sm">
            <i class="bi bi-pencil-square me-1"></i>Write Review
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content Area -->
  <div class="row">
    <!-- Reviews List Column (Left - 8 columns) -->
    <div class="col-lg-8">
      {% if reviews %}
      <!-- Reviews List -->
      <div class="reviews-list">
        {% for review in reviews %}
        <div class="card review-card">
          <div class="card-body">
            <!-- Review Header -->
            <div class="review-header">
              <div class="d-flex align-items-start mb-2">
                <div class="rating-stars me-3">
                  {% for i in "12345"|make_list %}
                  {% if forloop.counter <= review.rating %} <i class="bi bi-star-fill"></i>
                    {% else %}
                    <i class="bi bi-star"></i>
                    {% endif %}
                    {% endfor %}
                </div>
                {% if review.title %}
                <h5 class="review-title mb-0">{{ review.title }}</h5>
                {% endif %}
              </div>

              <div class="review-meta">
                <span class="fw-medium">{{ review.user.get_full_name|default:review.user.username }}</span>
                <span class="mx-1">•</span>
                <span>{{ review.created_at|date:"M d, Y" }}</span>
                {% if review.is_verified_purchase %}
                <span class="mx-1">•</span>
                <span class="verified-badge">
                  <i class="bi bi-patch-check-fill me-1"></i>Verified
                </span>
                {% endif %}
              </div>
            </div>

            <!-- Review Content -->
            <div class="review-content">
              <p class="mb-0">{{ review.comment|linebreaks }}</p>
            </div>

            <!-- Review Actions -->
            <div class="review-actions">
              <button
                class="btn btn-sm helpful-btn {% if user.is_authenticated and review.id in helpful_review_ids %}active{% else %}btn-outline-primary{% endif %}"
                data-review-id="{{ review.id }}" data-action-url="{% url 'reviews:mark_helpful' review.id %}"
                onclick="toggleHelpful(this)">
                <i
                  class="bi bi-hand-thumbs-up{% if user.is_authenticated and review.id in helpful_review_ids %}-fill{% endif %} me-1"></i>
                Helpful
                <span class="helpful-count ms-1">({{ review.helpful_count }})</span>
              </button>

              {% if user == review.user %}
              <a href="{% url 'reviews:add_review' review.menu_item.id %}" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-pencil me-1"></i>Edit
              </a>
              {% endif %}
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- Pagination -->
      {% if reviews.has_other_pages %}
      <div class="mt-4 pt-3 border-top">
        <nav aria-label="Reviews pagination">
          <ul class="pagination justify-content-center">
            {% if reviews.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?page={{ reviews.previous_page_number }}" aria-label="Previous">
                <span aria-hidden="true">&laquo;</span>
              </a>
            </li>
            {% else %}
            <li class="page-item disabled">
              <span class="page-link">&laquo;</span>
            </li>
            {% endif %}

            {% for num in reviews.paginator.page_range %}
            {% if reviews.number == num %}
            <li class="page-item active">
              <span class="page-link">{{ num }}</span>
            </li>
            {% elif num > reviews.number|add:'-3' and num < reviews.number|add:'3' %} <li class="page-item">
              <a class="page-link" href="?page={{ num }}">{{ num }}</a>
              </li>
              {% endif %}
              {% endfor %}

              {% if reviews.has_next %}
              <li class="page-item">
                <a class="page-link" href="?page={{ reviews.next_page_number }}" aria-label="Next">
                  <span aria-hidden="true">&raquo;</span>
                </a>
              </li>
              {% else %}
              <li class="page-item disabled">
                <span class="page-link">&raquo;</span>
              </li>
              {% endif %}
          </ul>
        </nav>
      </div>
      {% endif %}

      {% else %}
      <!-- Empty State -->
      <div class="empty-state">
        <div class="empty-state-icon">
          <i class="bi bi-chat-left-text"></i>
        </div>
        <h3 class="h5 mb-3">No reviews yet</h3>
        <p class="text-muted mb-4">Be the first to share your experience with this item!</p>
        <a href="{% url 'reviews:add_review' menu_item.id %}" class="btn btn-primary">
          <i class="bi bi-pencil-square me-2"></i>Write the First Review
        </a>
      </div>
      {% endif %}
    </div>

    <!-- Sidebar Column (Right - 4 columns) -->
    <div class="col-lg-4">
      <div class="sidebar-sticky">
        <!-- Rating Summary Card -->
        <div class="card sidebar-card">
          <div class="card-body">
            <h5 class="card-title mb-3">Rating Summary</h5>

            {% if reviews %}
            <div class="mb-3">
              <div class="d-flex align-items-center mb-3">
                <div class="display-5 fw-bold me-3">{{ menu_item.average_rating|default:0|floatformat:1 }}</div>
                <div>
                  <div class="rating-stars mb-1">
                    {% for i in "12345"|make_list %}
                    {% if forloop.counter <= menu_item.average_rating|default:0|floatformat:0 %} <i
                      class="bi bi-star-fill text-warning"></i>
                      {% else %}
                      <i class="bi bi-star text-warning"></i>
                      {% endif %}
                      {% endfor %}
                  </div>
                  <div class="text-muted small">{{ reviews.count }} review{{ reviews.count|pluralize }}</div>
                </div>
              </div>

              <!-- Rating Distribution -->
              <div class="rating-distribution">
                {% for i in "54321" %}
                {% with rating=i count=rating_distribution|get_item:i|default:0 %}
                <div class="d-flex align-items-center mb-2">
                  <div class="text-muted small me-2" style="width: 50px;">{{ rating }} star</div>
                  <div class="progress flex-grow-1" style="height: 6px;">
                    {% if reviews.count > 0 %}
                    <div class="progress-bar bg-warning" role="progressbar"
                      style="width: {% widthratio count reviews.count 100 %}%"></div>
                    {% else %}
                    <div class="progress-bar bg-warning" role="progressbar" style="width: 0%"></div>
                    {% endif %}
                  </div>
                  <div class="text-muted small ms-2" style="width: 30px;">
                    {{ count }}
                  </div>
                </div>
                {% endwith %}
                {% endfor %}
              </div>
            </div>
            {% else %}
            <div class="text-center py-3">
              <i class="bi bi-star text-muted mb-3" style="font-size: 2rem;"></i>
              <p class="text-muted mb-0">No ratings yet</p>
            </div>
            {% endif %}

            <!-- Write Review Button -->
            <div class="d-grid mt-3">
              <a href="{% url 'reviews:add_review' menu_item.id %}" class="btn btn-primary">
                <i class="bi bi-pencil-square me-2"></i>Write a Review
              </a>
            </div>
          </div>
        </div>

        <!-- About This Item Card -->
        <div class="card sidebar-card">
          <div class="card-body">
            <h5 class="card-title mb-3">About this item</h5>

            <div class="d-flex align-items-start mb-3">
              {% if menu_item.image %}
              <img src="{{ menu_item.image.url }}" alt="{{ menu_item.name }}" class="img-fluid rounded me-3"
                style="width: 60px; height: 60px; object-fit: cover;">
              {% else %}
              <div class="bg-light rounded d-flex align-items-center justify-content-center me-3"
                style="width: 60px; height: 60px;">
                <i class="bi bi-egg-fried text-muted"></i>
              </div>
              {% endif %}
              <div>
                <h6 class="mb-1 fw-bold">{{ menu_item.name }}</h6>
                <div class="text-muted small">{{ menu_item.category.name }}</div>
                {% if menu_item.price %}
                <div class="mt-1">
                  <span class="fw-bold text-success">{{ menu_item.price }}</span>
                </div>
                {% endif %}
              </div>
            </div>

            <!-- Item Stats -->
            <div class="row text-center border-top pt-3">
              <div class="col-6">
                <div class="h5 fw-bold text-primary">{{ reviews.count }}</div>
                <div class="small text-muted">Reviews</div>
              </div>
              <div class="col-6">
                <div class="h5 fw-bold text-success">{{ menu_item.average_rating|default:"0.0"|floatformat:1 }}</div>
                <div class="small text-muted">Rating</div>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="d-grid gap-2 mt-3">
              <a href="{% url 'menu:menu_detail' menu_item.id %}" class="btn btn-outline-primary btn-sm">
                <i class="bi bi-eye me-1"></i>View Details
              </a>
              <a href="{% url 'menu:menu_list' %}?category={{ menu_item.category.id }}"
                class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-grid me-1"></i>More {{ menu_item.category.name }}
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // Toggle helpful button
  function toggleHelpful(button) {
    const reviewId = button.getAttribute('data-review-id');
    const actionUrl = button.getAttribute('data-action-url');
    const helpfulCountSpan = button.querySelector('.helpful-count');

    fetch(actionUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({})
    })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          // Update button state
          if (data.action === 'added') {
            button.classList.remove('btn-outline-primary');
            button.classList.add('active');
            button.querySelector('i').classList.remove('bi-hand-thumbs-up');
            button.querySelector('i').classList.add('bi-hand-thumbs-up-fill');
          } else {
            button.classList.remove('active');
            button.classList.add('btn-outline-primary');
            button.querySelector('i').classList.remove('bi-hand-thumbs-up-fill');
            button.querySelector('i').classList.add('bi-hand-thumbs-up');
          }

          // Update count
          helpfulCountSpan.textContent = '(' + data.helpful_count + ')';
        }
      })
      .catch(error => {
        console.error('Error:', error);
      });
  }

  // Helper function to get CSRF token
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
</script>
{% endblock %}