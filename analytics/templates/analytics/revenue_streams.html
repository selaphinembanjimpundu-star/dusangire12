{% extends 'base.html' %}
{% load static %}

{% block title %}Revenue Analysis{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.css" rel="stylesheet">
<style>
    .revenue-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
    }
    
    .channel-item {
        padding: 15px;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .channel-item:last-child {
        border-bottom: none;
    }
    
    .channel-badge {
        background-color: #e9ecef;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 500;
    }
    
    .progress-bar-animated {
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    }
    
    .metric-box {
        text-align: center;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
    }
    
    .metric-box h3 {
        color: #007bff;
        margin: 0;
    }
    
    .metric-box p {
        color: #6c757d;
        margin-top: 5px;
        margin-bottom: 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="h3 mb-0">Revenue Analysis</h1>
            <p class="text-muted">Breakdown of revenue by channel and source</p>
        </div>
        <div class="col-md-4 text-end">
            <div class="btn-group">
                <a href="?days=7" class="btn btn-sm {% if days_selected == 7 %}btn-primary{% else %}btn-outline-primary{% endif %}">7 Days</a>
                <a href="?days=30" class="btn btn-sm {% if days_selected == 30 %}btn-primary{% else %}btn-outline-primary{% endif %}">30 Days</a>
                <a href="?days=90" class="btn btn-sm {% if days_selected == 90 %}btn-primary{% else %}btn-outline-primary{% endif %}">90 Days</a>
            </div>
        </div>
    </div>

    <!-- Total Revenue Card -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card revenue-card">
                <div class="card-body">
                    <h5 class="card-title">Total Revenue ({{ days_selected }} Days)</h5>
                    <h2 class="mb-0">RWF {{ total_revenue|floatformat:0 }}</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Revenue by Channel -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Revenue by Channel</h5>
                </div>
                <div class="card-body">
                    {% for stream in streams %}
                    <div class="channel-item">
                        <div class="flex-grow-1">
                            <div class="mb-2">
                                <strong>{{ stream.channel }}</strong>
                                <span class="channel-badge float-end">{{ stream.percentage|floatformat:1 }}%</span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar" style="width: {{ stream.percentage }}%"></div>
                            </div>
                            <small class="text-muted">
                                RWF {{ stream.total_amount|floatformat:0 }} â€¢ {{ stream.total_transactions }} transactions
                            </small>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-muted text-center py-4">No revenue data available for this period</p>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Channel Distribution</h5>
                </div>
                <div class="card-body">
                    <canvas id="channelChart" style="height: 300px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Daily Revenue Trend -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Daily Revenue Trend</h5>
                </div>
                <div class="card-body">
                    <canvas id="trendChart" style="height: 300px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Key Metrics -->
    <div class="row mb-4">
        <div class="col-md-4 mb-3">
            <div class="metric-box">
                <h3>{{ streams.0.total_transactions|default:'0' }}</h3>
                <p>Top Channel Transactions</p>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="metric-box">
                <h3>RWF {{ streams.0.total_amount|floatformat:0|default:'0' }}</h3>
                <p>Top Channel Revenue</p>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="metric-box">
                <h3>{{ streams|length }}</h3>
                <p>Active Revenue Channels</p>
            </div>
        </div>
    </div>

    <!-- Back Button -->
    <div class="row">
        <div class="col-12">
            <a href="{% url 'analytics:dashboard' %}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to Dashboard
            </a>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
<script>
// Channel Distribution Chart
const channelLabels = {{ streams|safe|django_json_encoder|safe }};
const channelData = {
    labels: [{% for s in streams %}'{{ s.channel }}'{% if not forloop.last %},{% endif %}{% endfor %}],
    datasets: [{
        data: [{% for s in streams %}{{ s.total_amount }}{% if not forloop.last %},{% endif %}{% endfor %}],
        backgroundColor: [
            '#007bff',
            '#28a745',
            '#ffc107',
            '#dc3545',
            '#17a2b8',
            '#6f42c1',
            '#e83e8c'
        ]
    }]
};

const channelCtx = document.getElementById('channelChart').getContext('2d');
new Chart(channelCtx, {
    type: 'pie',
    data: channelData,
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// Daily Trend Chart
fetch("{% url 'analytics:api_daily_revenue' %}?days={{ days_selected }}")
    .then(response => response.json())
    .then(data => {
        const trendCtx = document.getElementById('trendChart').getContext('2d');
        new Chart(trendCtx, {
            type: 'bar',
            data: {
                labels: data.dates,
                datasets: [{
                    label: 'Daily Revenue (RWF)',
                    data: data.revenue,
                    backgroundColor: 'rgba(0, 123, 255, 0.6)',
                    borderColor: '#007bff',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return 'RWF ' + value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
    });
</script>
{% endblock %}
